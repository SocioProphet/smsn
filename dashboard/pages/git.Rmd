## Git history

```{r}
git.log.file <- "data/git-log.csv"
git <- read.csv(file(git.log.file), header=FALSE)

timestamp <- {}
commit <- {}
committer <- {}
last.timestamp <- -1
last.commit <- ""
last.committer <- ""
for (i in c(1:nrow(git))) {
  if (git$V2[i] == "COMMIT") {
    last.timestamp <- git$V5[i]
    last.commit <- as.character(git$V3[i])
    last.committer <- as.character(git$V4[i])
  }
  timestamp[i] <- last.timestamp
  commit[i] <- last.commit
  committer[i] <- last.committer
}
time <- ISOdatetime(1970,1,1,0,0,0, tz="GMT") + timestamp

df <- data.frame(git, time=time, commit=commit, committer=committer)
df <- subset(df, V2=="FILE")
changes <- data.frame(entity=df$V3, lines=as.numeric(df$V4), source=df$V1, time=df$time, commit=df$commit, committer=df$committer)
changes <- changes[with(changes, order(time)),]
```

### All changes

```{r}
showTable(changes)
```

### Changes by committer

```{r}
committers <- unique(as.vector(changes$committer))

total.commits <- function(c) {
  df <- subset(changes, committer==c)
  num(length(unique(df$commit)))
}

total.entities.changed <- function(c) {
  df <- subset(changes, committer==c)
  num(length(unique(df$entity)))
}

total.lines.changed <- function(c) {
  df <- subset(changes, committer==c)
  num(sum(as.vector(as.numeric(df$lines))))
}

totals.by.author <- data.frame(committer=committers,
                               commits=sapply(committers, total.commits),
                               entities=sapply(committers, total.entities.changed),
                               lines=sapply(committers, total.lines.changed))
```

There are **`r num(length(committers))` committers in the log, responsible for the following cumulative changes.

```{r}
showSimpleTable(totals.by.author)
```

### Aggregate changes over time

```{r}
library(ggplot2)

day <- 60*60*24; week <- day*7; month <- day*30
min.t <- min(changes$time)
max.t <- max(changes$time)

breaks <- seq(min.t, max.t + month, by="months")
labels <- sapply(breaks[1:(length(breaks)-1)], function(t) { format(t, format="%Y-%m") })

plot.data <- {}
for (cm in committers) {
  ct <- hist(subset(changes, committer==cm)$time, breaks=breaks, plot=FALSE)$counts
  df <- data.frame(time=labels, committer=cm, entities=ct)
  plot.data <- rbind(plot.data, df)
}
```

The following plot shows the number of entities changed by each committer over time. The y-axis is rendered on a log scale, as some commits tend to be much larger than others.

```{r}
renderPlot(
  ggplot(plot.data, aes(x=factor(time), y=entities)) + 
    geom_bar(stat="identity", position="dodge", aes(fill = committer)) +
    scale_y_log10() +
    #geom_text(data=plot.data, aes(label=entities), size=3) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)))
```

### Preparing the data for this page

Create the data file `r git.log.file` by executing the script below, first setting the Bash variables for the input and output directories appropriately.

```bash
# the path to the smsn repository. The "dashboard" subdirectory should appear under this.
SMSN_HOME=...
# the path to your data; the Git directories from which you would like to extract logs should appear under this.
DATA_HOME=...

OUT_FILE=${SMSN_HOME}/dashboard/data/git-log.csv

mkdir -p ${SMSN_HOME}/dashboard/data
echo "" > ${OUT_FILE}
cd ${DATA_HOME}
for DIR in `echo */ | tr '/' '\n'`; do
  if [ -e ${DIR}/.git ]; then
      echo "adding Git log for "${DIR}
      cd ${DIR}
      git log --stat --pretty=format:"COMMIT,%h,%an,%at" \
  | grep "COMMIT\|[-+]$" | sed 's/^COMMIT/'${DIR}',COMMIT/' | sed 's/^ /'${DIR}',FILE,/' | sed 's/\.smsn//' | sed 's/  *\|  */,/' | sed 's/ [-+][-+]*$/,/' \
  >> ${OUT_FILE}
      cd ..
  fi
done
```
